<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Куки, document.cookie</title>
    <link href="../../style.css" rel="stylesheet">
    <script defer src="../../highlightElements.js"></script>
</head>
<body>
    <article>
        <h2>Куки, document.cookie</h2>
        <p>Куки - это небольшие строки данных, которые хранятся непосредственно в браузере. Они являются частью
        HTTP-протокола, определенного в спецификации <a target="_blank" href="https://datatracker.ietf.org/doc/html/rfc6265">RFC 6265</a>.</p>
        <p>Куки обычно устанавливаются веб-сервером при помощи заголовка <code>Set-Cookie</code>. Затем браузер
        будет автоматически добавлять их в (почти) каждый запрос на тот же домен при помощи заголовка <code>Cookie</code>.</p>
        <p>Один из наиболее частых случаев использования куки - это аутентификация:</p>
        <ol>
            <li>
                <p>При входе на сайт сервер отсылает в ответ HTTP-заголовок <code>Set-Cookie</code> для того, чтобы
                установить куки со специальным уникальным идентификатором сессии («session identifier»).</p>
            </li>
            <li>
                <p>Во время следующего запроса к этому же домену браузер посылает на сервер HTTP-заголовок
                <code>Cookie</code>.</p>
            </li>
            <li>
                <p>Таким образом, сервер понимает, кто сделал запрос.</p>
            </li>
        </ol>
        <p>Мы также можем получить доступ к куки непосредственно из браузера, используя свойство <code>document.cookie</code>.</p>
        <p>Куки имеют множество особенностей и тонкостей в использовании, и в этой главе мы подробно с ними разберемся.</p>
    </article>

    <article>
        <h2>Чтение из document.cookie</h2>
        <p>Хранит ли ваш браузер какие-то куки с этого сайта? Посмотрим:</p>
<pre><code class="language-javascript">// На javascript.info мы используем сервис Google Analytics для сбора статистики,
// поэтому какие-то куки должны быть
alert(document.cookie); // cookie1=value1; cookie2=value2; ...</code></pre>
        <p>Значение <code>document.cookie</code> состоит из пар <code>ключ=значение</code>, разделенных
        <code>;</code>. Каждая пара представляет собой отдельное куки.</p>
        <p>Чтобы найти определенное куки, достаточно разбить строку из <code>document.cookie</code> по <code>;</code>,
        и затем найти нужный ключ. Для этого мы можем использовать как регулярные выражения, так и функции для
        обработки массивов.</p>
    </article>

    <article>
        <h2>Запись в document.cookie</h2>
        <p>Мы можем писать в <code>document.cookie</code>. Но это не просто свойство данных, а
        <a target="_blank" href="../../Язык%20JavaScript/7.%20Свойства%20объекта,%20их%20конфигурация/2.%20Свойства%20-%20геттеры%20и%20сеттеры/index.html">аксессор (геттер/сеттер)</a>.
        Присваивание к нему обрабатывается особым образом.</p>
        <p><b>Запись в <code>document.cookie</code> обновит только упомянутые в ней куки, но при этом не затронет
        все остальные.</b></p>
        <p>Например, этот вызов установит куки с именем <code>user</code> и значением <code>John</code>:</p>
<pre><code class="language-javascript">document.cookie = 'user=John'; // Обновляем только куки с именем 'user'
alert(document.cookie); // Показываем все куки</code></pre>
        <div style="margin: 0.5rem">
            <button>Запустить пример</button>
        </div>
        <script>
            document.currentScript.previousElementSibling.firstElementChild.addEventListener('click', function() {
                document.cookie = 'user=John';
                alert(document.cookie);
            });
        </script>
        <p>Если вы запустите этот код, то, скорее всего, увидите множество куки. Это происходит, потому что
        операция <code>document.cookie=</code> перезапишет не все куки, а лишь куки с вышеупомянутым именем
        <code>user</code>.</p>
        <p>Технически, и имя и значение куки могут состоять из любых символов, для правильного форматирования
        следует использовать встроенную функцию <code>encodeURIComponent</code>:</p>
<pre><code class="language-javascript">// Специальные символы (пробелы), требуется кодирование
let name = 'my name';
let value = 'John Smith';

// Кодирует в my%20name=John%20Smith
document.cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value);

alert(document.cookie); // ...; my%20name=John%20Smith</code></pre>
        <div style="margin: 0.5rem">
            <button>Запустить пример</button>
        </div>
        <script>
            document.currentScript.previousElementSibling.firstElementChild.addEventListener('click', function() {
                let name = 'my name';
                let value = 'John Smith';

                document.cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value);

                alert(document.cookie);
            });
        </script>

        <article class="warning">
            <h3>Ограничения</h3>
            <p>Существует несколько ограничений:</p>
            <ul>
                <li>
                    <p>После <code>encodeURIComponent</code> пара <code>name=value</code> не должна занимать более
                    4Кб. Таким образом, мы не можем хранить в куки большие данные.</p>
                </li>
                <li>
                    <p>Общее количество куки на один домен ограничивается примерно 20+. Точное ограничение зависит
                    от конкретного браузера.</p>
                </li>
            </ul>
        </article>

        <p>У куки есть ряд настроек, многие из которых важны и должны быть установлены.</p>
        <p>Эти настройки указываются после пары <code>ключ=значение</code> и отделены друг от друга разделением
        <code>;</code> вот так:</p>
<pre><code class="language-javascript">document.cookie = 'user=John; path=/; expires=Tue, 19 Jan 2038 03:14:07 GMT';</code></pre>
    </article>

    <article>
        <h2>path</h2>
        <ul>
            <li>
                <p><code>path=/mypath</code></p>
            </li>
        </ul>
        <p>URL-префикс пути, куки будут доступны для страниц под этим путем. Должен быть абсолютным. По умолчанию
        используется текущий путь.</p>
        <p>Если куки установлено с <code>path=/admin</code>, то оно будет доступно на страницах <code>/admin</code>
        и <code>/admin/something</code>, но не на страницах <code>/home</code> или <code>/adminpage</code>.</p>
        <p>Как правило, указывают в качестве пути корень <code>path=/</code>, чтобы наше куки было доступно на всех
        страницах сайта.</p>
    </article>

    <article>
        <h2>domain</h2>
        <ul>
            <li>
                <p><code>domain=site.com</code></p>
            </li>
        </ul>
        <p>Домен определяет, где доступен файл куки. Однако на практике существуют определенные ограничения.
        Мы не можем указать здесь какой угодно домен.</p>
        <p><b>Нет никакого способа разрешить доступ к файлам куки из другого домена 2-го уровня, поэтому
        <code>other.com</code> никогда не получит куки, установленные по адресу <code>site.com</code>.</b></p>
        <p>Это ограничение безопасности, позволяющее нам хранить конфиденциальные данные в файлах куки, которые должны
        быть доступны только на этом сайте.</p>
        <p>По умолчанию куки доступны лишь тому домену, который его установил.</p>
        <p>Пожалуйста, обратите внимание, что по умолчанию файл куки также не передается поддомену, например,
        <code>forum.site.com</code>.</p>
<pre><code class="language-javascript">// Если мы установим файл куки на веб-сайте site.com...
document.cookie = 'user=John';

// ... Мы не увидим его на forum.site.com
alert(document.cookie); // нет user</code></pre>
        <p>... Но это можно изменить. Если мы хотим разрешить поддомен типа <code>forum.site.com</code> получать куки,
        установленные на <code>site.com</code>, это возможно.</p>
        <p>Чтобы это произошло, при установке файла куки в <code>site.com</code>, мы должны явно установить параметр
        <code>domain</code> для корневого домена: <code>domain=site.com</code>. После этого все поддомены увидят такой
        файл cookie.</p>
        <p>Например:</p>
<pre><code class="language-javascript">// Находясь на странице site.com
// сделаем куки доступным для всех поддоменов *.site.com:
document.cookie = 'user=John; domain=site.com';

// Позже

// На forum.site.com
alert(document.cookie); // есть куки user=John</code></pre>
        <p>По историческим причинам установка <code>domain=.site.com</code> (с точкой перед <code>site.com</code>) также
        работает и разрешает доступ к куки для поддоменов. Это старая запись, но можно использовать и ее, если нужно,
        чтобы поддерживались очень старые браузеры.</p>
        <p>Таким образом, опция <code>domain</code> позволяет нам разрешить доступ к куки для поддоменов.</p>
    </article>

    <article>
        <h2>expires, max-age</h2>
        <p>По умолчанию, если куки не имеют ни одного из этих параметров, то они удаляются при закрытии браузера.
        Такие куки называются сессионными («session cookies»).</p>
        <p>Чтобы помочь куки «пережить» закрытие браузера, мы можем установить значение опций <code>expires</code>
        или <code>max-age</code>.</p>
        <ul>
            <li>
                <p><code>expires=Tue, 19 Jan 2038 03:14:07 GMT</code></p>
            </li>
        </ul>
        <p>Дата истечения срока действия куки, когда браузер удалит его автоматически.</p>
        <p>Дата должна быть точно в этом формате, во временной зоне GMT. Мы можем использовать <code>data.toUTCString</code>,
        чтобы получить правильную дату. Например, мы можем установить срок действия куки на 1 день.</p>
<pre><code class="language-javascript">// +1 день от текущей даты
let date = new Date(Date.now + 86400e3);
date = date.toUTCString();
document.cookie = 'user=John; expires=' + date;</code></pre>
        <p>Если мы установим в <code>expires</code> прошедшую дату, то куки будет удалено.</p>
        <ul>
            <li>
                <p><code>max-age=3600</code></p>
            </li>
        </ul>
        <p>Альтернатива <code>expires</code>, определяет срок действия куки в секундах с текущего момента.</p>
        <p>Если задан ноль или отрицательное значение, то куки будет удалено:</p>
<pre><code class="language-javascript">// Куки будет удалено через 1 час
document.cookie = 'user=John; max-age=3600';

// Удалим куки (срок действия истекает прямо сейчас)
document.cookie = 'user=John; max-age=0';</code></pre>
    </article>

    <article>
        <h2>secure</h2>
        <ul>
            <li>
                <p><code>secure</code></p>
            </li>
        </ul>
        <p>Куки следует передавать только по HTTPS-протоколу.</p>
        <p><b>По умолчанию куки, установленные сайтом <code>http://site.com</code>, также будут доступны на сайте
        <code>https://site.com</code> и наоборот.</b></p>
        <p>То есть, куки, по умолчанию, опираются на доменное имя, они не обращают внимания на протоколы.</p>
        <p>С этой настройкой, если куки будет установлено на сайте <code>https://site.com</code>, то оно не будет
        доступно на том же сайте с протоколом HTTP, как <code>http://site.com</code>. Таким образом, если в куки
        хранится конфиденциальная информация, которую не следует передавать по незашифрованному протоколу HTTP,
        то нужно установить этот флаг.</p>
<pre><code class="language-javascript">// Предполагается, что сейчас мы на https://
// Установим опцию secure для куки (куки доступно только через HTTPS)
document.cookie = 'user=John; secure';</code></pre>
    </article>

    <article>
        <h2>samesite</h2>
        <p>Это еще одна настройка безопасности, применяется для защиты от так называемой XSRF-атаки
        (межсайтовая подделка запроса).</p>
        <p>Чтобы понять, как настройка работает и где может быть полезной, посмотрим на XSRF-атаки.</p>
    </article>

    <article>
        <h2>Атака XSRF</h2>
        <p>Представьте, что вы авторизовались на сайте <code>bank.com</code>. То есть: у вас есть куки для аутентификации
        с этого сайта. Ваш браузер отправляет его на <code>bank.com</code> с каждым запросом, чтобы сервер этого
        сайта узнавал вас и выполнял все конфиденциальные финансовые операции.</p>
        <p>Теперь, просматривая веб-страницу в другом окне, вы случайно переходите на сайт <code>evil.com</code>,
        который автоматически отправляет форму <code>&lt;form action="https://bank.com/pay"&gt;</code>
        на сайт <code>bank.com</code> с заполненными полями, которые инициируют транзакцию на счет хакера.</p>
        <p>Браузер посылает куки при каждом посещении <code>bank.com</code>, даже если форма была отправлена
        с <code>evil.com</code>. Таким образом, банк узнает вас и выполнит платеж.</p>
        <img src="images/cookie-xsrf.svg" alt style="width: 50vw">
        <p>Такая атака называется межсайтовая подделка запроса (или Cross-Site Request Forgery, XSRF).</p>
        <p>Конечно же, в реальной жизни банки защищены от такой атаки. Во всех сгенерированных сайтом
        <code>bank.com</code> формах есть специальное поле, так называемый «токен защиты от XSRF», который
        вредоносная страница не может ни сгенерировать, ни каким-либо образом извлечь из удаленной страницы
        (она может отправить форму туда, но не может получить данные обратно). И сайт <code>bank.com</code>
        при получении формы проверяет его наличие.</p>
        <p>Но такая защита требует усилий на ее реализацию: нам нужно убедиться, что в каждой форме есть поле
        с токеном, также мы должны проверить все запросы.</p>
    </article>

    <article>
        <h2>Настройка samesite</h2>
        <p>Параметр куки <code>samesite</code> предоставляет еще один способ защиты от таких атак, который (теоретически)
        не должен требовать «токенов защиты XSRF».</p>
        <p>У него есть два возможных значения:</p>
        <ul>
            <li>
                <p><code>samesite=strict</code> <b>(или, что то же самое, <code>samesite</code>)</b></p>
            </li>
        </ul>
        <p>Куки с <code>samesite=strict</code> никогда не отправятся, если пользователь пришел не с этого же сайта.</p>
        <p>Другими словами, если пользователь переходит по ссылке из почты, отправляет форму с <code>evil.com</code>
        или выполняет любую другую операцию, происходящую с другого домена, то куки не отправятся.</p>
        <p>Если куки имеют настройку <code>samesite</code>, то атака XSRF не имеет шансов на успех, потому что
        отправка с сайта <code>evil.com</code> происходит без куки. Таким образом, сайт <code>bank.com</code>
        не распознает пользователя и не произведет платеж.</p>
        <p>Защита довольно надежная. Куки с настройкой <code>samesite</code> будет отправлено только в том случае,
        если операции происходят с сайта <code>bank.com</code>, например, отправка формы сделана со страницы
        на <code>bank.com</code>.</p>
        <p>Хотя есть небольшие неудобства.</p>
        <p>Когда пользователь перейдет по ссылке на <code>bank.com</code>, например, из своих заметок, то будет
        удивлен, что сайт <code>bank.com</code> не узнал его. Действительно, куки с <code>samesite=strict</code>
        в этом случае не отправляется.</p>
        <p>Мы могли бы обойти это ограничение, используя два куки: одно куки для «общего узнавания», только для того,
        чтобы поздороваться: «Привет, Джон», и другое куки для операций изменения данных с <code>samesite=strict</code>.
        Тогда пользователь, пришедший на сайт, увидит приветствие, но платежи нужно инициировать с сайта банка,
        чтобы отправилось второе куки.</p>
        <ul>
            <li>
                <p><code>samesite=lax</code></p>
            </li>
        </ul>
        <p>Это более мягкий вариант, который также защищает от XSRF и при этом не портит впечатление от использования
        сайта.</p>
        <p>Режим <code>lax</code> так же, как и <code>strict</code>, запрещает браузеру отправлять куки, когда запрос
        происходит не с сайта, но добавляет одно исключение.</p>
        <p>Куки с <code>samesite=lax</code> отправляется, если два этих условия верны:</p>
        <ol>
            <li>
                <p>Используются безопасные HTTP-методы (например GET, но не POST).</p>
                <p>Полный список безопасных HTTP-методов можно посмотреть в спецификации
                <a target="_blank" href="https://datatracker.ietf.org/doc/html/rfc7231#section-4.2.1">RFC7231</a>.
                По сути, безопасными считаются методы, которые обычно используются для чтения, но не для записи данных.
                Оно не должно выполнять никаких операций на изменение данных. Переход по ссылке является всегда
                GET-методом, то есть безопасным.</p>
            </li>
            <li>
                <p>Операция осуществляет навигацию верхнего уровня (изменяет URL в адресной строке браузера).</p>
                <p>Обычно это так, но если навигация выполняется в <code>&lt;iframe&gt;</code>, то это не верхний уровень.
                Кроме того, JavaScript-методы для сетевых запросов не выполняют никакой навигации, поэтому они не
                подходят.</p>
            </li>
        </ol>
        <p>Таким образом, режим <code>samesite=lax</code> позволяет самой распространенной операции «переход по ссылке»
        передавать куки. Например, открытие сайта из заметок удовлетворяет этим условиям.</p>
        <p>Но что-то более сложное, например, сетевой запрос с другого сайта или отправка формы, теряет куки.</p>
        <p>Если это вам подходит, то добавление <code>samesite=lax</code>, скорее всего, не испортит впечатление
        пользователей от работы с сайтом и добавит защиту.</p>
        <p>В целом, <code>samesite</code> отличная настройка.</p>
        <p>Но у нее есть важные недостаток:</p>
        <ul>
            <li>
                <p><code>samesite</code> игнорируется (не поддерживается) старыми браузерами, выпущенными до 2017 года
                и ранее.</p>
            </li>
        </ul>
        <p><b>Так что, если мы будем полагаться исключительно на <code>samesite</code>, то старые браузеры будут
        уязвимы.</b></p>
        <p>Но мы, безусловно, можем использовать <code>samesite</code> вместе с другими методами защиты, такими как
        XSRF-токены, чтобы добавить дополнительный слой защиты, а затем, в будущем, когда старые браузеры полностью
        исчезнут, мы, вероятно, сможем полностью удалить XSRF-токены.</p>
    </article>

    <article>
        <h2>httpOnly</h2>
        <p>Эта настройка не имеет ничего общего с JavaScript, но мы должны упомянуть ее для полноты изложения.</p>
        <p>Веб-сервер использует заголовок <code>Set-Cookie</code> для установки куки. И он может установить настройку
        <code>httpOnly</code>.</p>
        <p>Эта настройка запрещает любой доступ к куки из JavaScript. Мы не можем увидеть такое куки или манипулировать
        им с помощью <code>document.cookie</code>.</p>
        <p>Эта настройка используется в качестве меры предосторожности от определенных атак, когда хакер внедряет
        свой собственный JavaScript-код в страницу и ждет, когда пользователь посетит ее. Это вообще не должно
        быть возможным, хакер не должен быть в состоянии внедрить свой код на ваш сайт, но могут быть ошибки,
        которые позволят хакеру сделать это.</p>
        <p>Обычно, если такое происходит, и пользователь заходит на страницу с JavaScript-кодом хакера, то этот код
        выполняется и получает доступ к <code>document.cookie</code>, и тем самым к куки пользователя, которые содержат
        аутентификационную информацию. Это плохо.</p>
        <p>Но если куки имеет настройку <code>httpOnly</code>, то <code>document.cookie</code> не видит его, поэтому
        такое куки защищено.</p>
    </article>

    <article>
        <h2>Приложение: Функции для работы с куки</h2>
        <p>Вот небольшой набор функций для работы с куки, более удобных, чем ручная модификация <code>document.cookie</code>.</p>
        <p>Для этого существует множество библиотек, так что они, скорее, в демонстрационных целях. Но при этом
        полностью рабочие.</p>

        <h3>getCookie(name)</h3>
        <p>Самый который способ получить доступ к куки - это использовать
        <a target="_blank" href="https://learn.javascript.ru/regular-expressions">регулярные выражения</a>.</p>
        <p>Функция <code>getCookie(name)</code> возвращает куки с указанным <code>name</code>:</p>
<pre><code class="language-javascript">// Возвращает куки с указанным name,
// или undefined, если ничего не найдено
function getCookie(name) {
    let matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
    ));
    return matches ? decodeURIComponent(matches[1]) : undefined;
}</code></pre>
        <p>Здесь <code>new RegExp</code> генерируется динамически, чтобы находить <code>; name=&lt;value&gt;</code>.</p>
        <p>Обратите внимание, значение куки кодируется, поэтому <code>getCookie</code> использует внутреннюю
        функцию <code>decodeURIComponent</code> для декодирования.</p>

        <h3>setCookie(name, value, options)</h3>
        <p>Устанавливает куки с именем <code>name</code> и значением <code>value</code>, с настройкой
        <code>path=/</code> по умолчанию можно изменить, чтобы добавить другие значения по умолчанию):</p>
<pre><code class="language-javascript">function setCookie(name, value, options = {}) {

    options = {
        path: '/',
        // При необходимости добавьте другие значения по умолчанию
        ...options
    };

    if (options.expires instanceof Date) {
        options.expires = options.expires.toUTCString();
    }

    let updatedCookie = encodeURIComponent(name) + '=' + encodeURIComponent(value);

    for (let optionKey in options) {
        updatedCookie += '; ' + optionKey;
        let optionValue = option[optionKey];
        if (optionValue !== true)
            updatedCookie += '=' + optionValue;
        }
    }

    document.cookie = updatedCookie;
}

// Пример использования:
setCookie('user', 'John', {secure: true, 'max-age': 3600});</code></pre>

        <h3>deleteCookie(name)</h3>
        <p>Чтобы удалить куки, мы можем установить отрицательную дату истечения срока действия:</p>
<pre><code class="language-javascript">function deleteCookie(name) {
    setCookie(name, '', {max-age: -1});
}</code></pre>

        <article class="warning">
            <h3>Операции обновления или удаления куки должны использовать те же пути и домен</h3>
            <p>Обратите внимание: когда мы обновляем или удаляем куки, нам следует использовать только
            такие же настройки пути и домена, как при установке куки.</p>
        </article>

        <p>Все вместе: <a target="_blank" href="https://learn.javascript.ru/article/cookie/cookie.js">cookie.js</a>.</p>
    </article>

    <article>
        <h2>Приложение: Сторонние куки</h2>
        <p>Куки называются сторонними, если они размещены с домена, отличающегося от страницы, которую посещает пользователь.</p>
        <p>Например:</p>
        <ol>
            <li>
                <p>Страница <code>site.com</code> загружает баннер с другого сайта:
                <code>&lt;img src="https://ads.com/banner.png"&gt;</code>.</p>
            </li>
            <li>
                <p>Вместе с баннером удаленный сервер <code>ads.com</code> может установить заголовок <code>Set-Cookie</code>
                с куки, например, <code>id=123</code>. Такие куки создаются с домена <code>ads.com</code> и будут
                видны только на сайте <code>ads.com</code>:</p>
                <img src="images/cookie-third-party.svg" alt style="width: 50vw">
            </li>
            <li>
                <p>В следующий раз при доступе к <code>ads.com</code> удаленный сервер получит куки <code>id</code>
                и распознает пользователя:</p>
                <img src="images/cookie-third-party-2.svg" alt style="width: 50vw">
            </li>
            <li>
                <p>Что еще более важно, когда пользователь переходит с <code>site.com</code> на другой сайт
                <code>other.com</code>, на котором тоже есть баннер, то <code>ads.com</code> получит куки, так как
                они принадлежат <code>ads.com</code>, таким образом <code>ads.com</code> распознает пользователя
                и может отслеживать его перемещение между сайтами:</p>
                <img src="images/cookie-third-party-3.svg" alt style="width: 50vw">
            </li>
        </ol>
        <p>Сторонние куки в силу своей специфики обычно используются для целей отслеживания посещаемых пользователем
        страниц и показа рекламы. Они привязаны к исходному домену, поэтому <code>ads.com</code> может отслеживать
        одного и того же пользователя на разных сайтах, если оттуда идет обращение к нему.</p>
        <p>Естественно, некоторым пользователям не нравится, когда их отслеживают, поэтому браузеры позволяют отключать
        такие куки.</p>
        <p>Кроме того, некоторые современные браузеры используют специальные политики для таких куки:</p>
        <ul>
            <li>
                <p>Safari вообще не разрешает сторонние куки.</p>
            </li>
            <li>
                <p>У Firefox есть «черный список» сторонних доменов, чьи сторонние куки он блокирует.</p>
            </li>
        </ul>

        <article class="note">
            <h3>На заметку:</h3>
            <p>Если мы загружаем скрипт со стороннего домена, например
            <code>&lt;script src="https://google-analytics.com/analytics.js"&gt;</code>, и этот скрипт использует
            <code>document.cookie</code>, чтобы установить куки, то такие куки не являются сторонними.</p>
            <p>Если скрипт устанавливает куки, то нет разницы откуда был загружен скрипт - куки принадлежит
            домену текущей веб-страницы.</p>
        </article>

    </article>

    <article>
        <h2>Приложение: GDPR</h2>
        <p>Эта тема вообще не связана с JavaScript, но следует ее иметь в виду при установке куки.</p>
        <p>В Европе существует законодательство под названием GDPR, которое устанавливает для сайтов ряд правил,
        обеспечивающих конфиденциальность пользователей. И одним из таких правил является требование явного
        разрешения от пользователя на использование отслеживающих куки.</p>
        <p>Обратите внимание, это относится только к куки, используемых для отслеживания/идентификации/авторизации.</p>
        <p>То есть, если мы установим куки, которые просто сохраняют некоторую информацию, но не отслеживают
        и не идентифицируют пользователя, то мы свободны от этого правила.</p>
        <p>Но если мы собираемся установить куки с информацией об аутентификации или с идентификатором отслеживания,
        то пользователь должен явно разрешить это.</p>
        <p>Есть два основных варианта как сайты следуют GDPR. Вы наверняка уже видели их в сети:</p>
        <ol>
            <li>
                <p>Если сайт хочет установить куки для отслеживания только для авторизованных пользователей.</p>
                <p>То в регистрационной форме должен быть установлен флажок «принять политику конфиденциальности»
                (которая определяет, как используются куки), пользователь должен установить его, и только тогда
                сайт сможет использовать авторизационные куки.</p>
            </li>
            <li>
                <p>Если сайт хочет установить куки для отслеживания всем пользователям.</p>
                <p>Чтобы сделать это законно, сайт показывает модальное окно для пользователей, которые зашли в первый
                раз, и требуют от них согласие на использование куки. Затем сайт может установить такие куки
                и показать пользователю содержимое страницы. Хотя это создает неудобства для новых посетителей -
                никому не нравится наблюдать модальные окна вместо контента. Но GDPR в данной ситуации требует
                явного согласия пользователя.</p>
            </li>
        </ol>
        <p>GDPR касается не только куки, но и других вопросов, связанных с конфиденциальностью, которые выходят за рамки
        материала этой главы.</p>
    </article>

    <article>
        <h2>Итого</h2>
        <p><code>document.cookie</code> предоставляет доступ к куки.</p>
        <ul>
            <li>
                <p>Операция записи изменяет только то куки, которое было указано.</p>
            </li>
            <li>
                <p>Имя и значение куки должны быть закодированы.</p>
            </li>
            <li>
                <p>Одно куки вмещает до 4Kb данных, разрешается более 20 куки на сайт (зависит от браузера).</p>
            </li>
        </ul>
        <p>Настройки куки:</p>
        <ul>
            <li>
                <p><code>path=/</code>, по умолчанию устанавливается текущий путь, делает куки видимым только
                по указанному пути и ниже.</p>
            </li>
            <li>
                <p><code>domain=site.com</code>, по умолчанию куки видны только на текущем домене, если явно указан
                домен, то куки видны и на поддоменах.</p>
            </li>
            <li>
                <p><code>expires</code> или <code>max-age</code> устанавливает дату истечения срока действия, без них
                куки умрет при закрытии браузера.</p>
            </li>
            <li>
                <p><code>secure</code> делает куки доступными только при использовании HTTPS.</p>
            </li>
            <li>
                <p><code>samesite</code> запрещает браузеру отправлять куки с запросами, поступающими извне,
                помогает предотвратить XSRF-атаки.</p>
            </li>
        </ul>
        <p>Дополнительно:</p>
        <ul>
            <li>
                <p>Сторонние куки могут быть запрещены браузером, например Safari делает это по умолчанию.</p>
            </li>
            <li>
                <p>Установка отслеживающих куки пользователям из стран ЕС требует их явного согласия на это в
                соответствии с законодательством GDPR.</p>
            </li>
        </ul>
    </article>
</body>
</html>